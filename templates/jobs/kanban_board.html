{% extends 'base.html' %}
{% load static %}

{% block title %}Kanban Board - {{ job.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="background: #f8f9fa; min-height: calc(100vh - 76px);">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{% url 'jobs:employer_dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ job.title }}</li>
                </ol>
            </nav>
            <h2 class="fw-bold mb-0">Applicant Tracking Board</h2>
        </div>
        <a href="{% url 'jobs:job_applicants' job.slug %}" class="btn btn-outline-secondary">
            <i class="fas fa-list me-2"></i>List View
        </a>
    </div>

    <!-- Kanban Columns -->
    <div class="row g-3 flex-nowrap overflow-auto pb-4" id="kanban-board">
        <!-- Pending -->
        <div class="col-12 col-md-6 col-lg-3" style="min-width: 300px;">
            <div class="bg-light rounded h-100 border">
                <div class="p-3 border-bottom bg-white rounded-top d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-secondary"><i class="fas fa-clock me-2"></i>Pending Review</h6>
                    <span class="badge bg-secondary rounded-pill" id="count-pending">{{ pending.count }}</span>
                </div>
                <div class="p-2 kanban-col" data-status="pending" style="min-height: 500px;">
                    {% for app in pending %}
                        {% include 'jobs/includes/kanban_card.html' with app=app %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Reviewing -->
        <div class="col-12 col-md-6 col-lg-3" style="min-width: 300px;">
            <div class="bg-light rounded h-100 border">
                 <div class="p-3 border-bottom bg-white rounded-top d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-info"><i class="fas fa-glasses me-2"></i>Reviewing</h6>
                    <span class="badge bg-info rounded-pill text-white" id="count-reviewing">{{ reviewing.count }}</span>
                </div>
                <div class="p-2 kanban-col" data-status="reviewing" style="min-height: 500px;">
                    {% for app in reviewing %}
                        {% include 'jobs/includes/kanban_card.html' with app=app %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Shortlisted -->
        <div class="col-12 col-md-6 col-lg-3" style="min-width: 300px;">
            <div class="bg-light rounded h-100 border">
                 <div class="p-3 border-bottom bg-white rounded-top d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-primary"><i class="fas fa-star me-2"></i>Shortlisted</h6>
                    <span class="badge bg-primary rounded-pill" id="count-shortlisted">{{ shortlisted.count }}</span>
                </div>
                <div class="p-2 kanban-col" data-status="shortlisted" style="min-height: 500px;">
                    {% for app in shortlisted %}
                        {% include 'jobs/includes/kanban_card.html' with app=app %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Rejected -->
        <div class="col-12 col-md-6 col-lg-3" style="min-width: 300px;">
            <div class="bg-light rounded h-100 border">
                 <div class="p-3 border-bottom bg-white rounded-top d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-danger"><i class="fas fa-times-circle me-2"></i>Rejected</h6>
                    <span class="badge bg-danger rounded-pill" id="count-rejected">{{ rejected.count }}</span>
                </div>
                <div class="p-2 kanban-col" data-status="rejected" style="min-height: 500px;">
                    {% for app in rejected %}
                        {% include 'jobs/includes/kanban_card.html' with app=app %}
                    {% endfor %}
                </div>
            </div>
        </div>

         <!-- Hired -->
        <div class="col-12 col-md-6 col-lg-3" style="min-width: 300px;">
            <div class="bg-light rounded h-100 border">
                 <div class="p-3 border-bottom bg-white rounded-top d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-success"><i class="fas fa-check-circle me-2"></i>Hired</h6>
                    <span class="badge bg-success rounded-pill" id="count-hired">{{ hired.count }}</span>
                </div>
                <div class="p-2 kanban-col" data-status="hired" style="min-height: 500px;">
                    {% for app in hired %}
                        {% include 'jobs/includes/kanban_card.html' with app=app %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Resume Preview (Simple) -->
<div class="modal fade" id="resumeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Applicant Resume</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <iframe src="" style="width:100%; height:500px;" frameborder="0" id="resumeFrame"></iframe>
            </div>
        </div>
    </div>
</div>

<style>
    .kanban-card {
        cursor: grab;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .kanban-card:active {
        cursor: grabbing;
        transform: rotate(2deg);
    }
    .kanban-col.drag-over {
        background-color: #e9ecef;
        border: 2px dashed #adb5bd;
    }
    .gu-mirror {
        position: fixed !important;
        margin: 0 !important;
        z-index: 9999 !important;
        opacity: 0.8;
    }
    .gu-hide {
        display: none !important;
    }
    .gu-unselectable {
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        user-select: none !important;
    }
    .gu-transit {
        opacity: 0.2;
    }
</style>

<!-- Dragula for Drag and Drop -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.min.css">

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const containers = Array.from(document.querySelectorAll('.kanban-col'));
        const drake = dragula(containers);

        drake.on('drop', function(el, target, source, sibling) {
            const appId = el.getAttribute('data-app-id');
            const newStatus = target.getAttribute('data-status');
            
            // Update UI counts (simple version)
            updateCounts(source, target);

            // Send AJAX request
            fetch(`/job/application/${appId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if(data.status !== 'success') {
                    alert('Error updating status');
                    drake.cancel(true);
                }
            });
        });

        function updateCounts(source, target) {
            // This is a naive update, ideally fetch fresh counts or decrement source/increment target
            // implementation skipped for brevity
        }
    });

    function viewResume(url) {
        document.getElementById('resumeFrame').src = url;
        new bootstrap.Modal(document.getElementById('resumeModal')).show();
    }
</script>
{% endblock %}
