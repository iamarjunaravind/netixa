{% extends 'base.html' %}
{% load static %}

{% block title %}Messaging | Netixa{% endblock %}

{% block content %}
<div class="container py-4 h-100" style="padding-bottom: 2rem;">
    <div class="card border rounded-0" style="min-height: 80vh;">
        <div class="row g-0 h-100">
            <!-- Sidebar / Conversation List -->
            <div class="col-md-4 border-end h-100 d-flex flex-column">
                <div class="p-3 border-bottom bg-subtle">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-bold">Messaging</h5>
                        <button class="btn btn-sm btn-ghost p-1" data-bs-toggle="modal" data-bs-target="#newMessageModal" title="New Message"><i class="fas fa-edit fs-5"></i></button>
                    </div>
                </div>
                
                <div class="flex-grow-1 overflow-auto bg-white p-0">
                    <div class="list-group list-group-flush" id="conversationList">
                        {% for conv in conversations %}
                        <a href="#" class="list-group-item list-group-item-action border-0 py-3 conversation-item" 
                           data-recipient-id="{{ conv.other_user.id }}"
                           data-recipient-name="{{ conv.other_user.username }}"
                           data-context-type="{{ conv.type }}"
                           data-context-title="{{ conv.context_title }}"
                           data-job-id="{{ conv.job_id|default:'' }}"
                           data-course-id="{{ conv.course_id|default:'' }}">
                            <div class="d-flex align-items-center">
                                <div class="position-relative">
                                    <img src="{% if conv.other_user.profile_picture %}{{ conv.other_user.profile_picture.url }}{% else %}https://ui-avatars.com/api/?name={{ conv.other_user.username }}&background=random{% endif %}" 
                                         class="rounded-circle" width="45" height="45">
                                    {% if conv.priority == 1 %}
                                    <span class="position-absolute bottom-0 end-0 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 20px; height: 20px; font-size: 10px;" title="Job"><i class="fas fa-briefcase"></i></span>
                                    {% elif conv.priority == 2 %}
                                    <span class="position-absolute bottom-0 end-0 bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 20px; height: 20px; font-size: 10px;" title="Course"><i class="fas fa-book"></i></span>
                                    {% endif %}
                                </div>
                                <div class="ms-3 flex-grow-1 overflow-hidden">
                                    <div class="d-flex justify-content-between align-items-baseline">
                                        <h6 class="mb-0 text-truncate fw-bold">{{ conv.other_user.username }}</h6>
                                        <small class="text-muted text-xs">{{ conv.last_message.timestamp|date:"M d" }}</small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <p class="mb-0 text-muted text-sm text-truncate flex-grow-1">
                                            {% if conv.last_message.sender == request.user %}You: {% endif %}{{ conv.last_message.content }}
                                        </p>
                                    </div>
                                    {% if conv.type != 'direct' %}
                                    <small class="text-xs text-primary bg-primary-subtle px-2 py-0.5 rounded-pill d-inline-block mt-1">{{ conv.context_title }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <!-- Hidden JSON for messages -->
                            <script type="application/json" class="messages-data">
                                [
                                    {% for msg in conv.messages reversed %}
                                    {
                                        "content": "{{ msg.content|escapejs }}",
                                        "sender_id": {{ msg.sender.id }},
                                        "timestamp": "{{ msg.timestamp|date:'M d, H:i' }}",
                                        "is_me": {% if msg.sender == request.user %}true{% else %}false{% endif %}
                                    }{% if not forloop.last %},{% endif %}
                                    {% endfor %}
                                ]
                            </script>
                        </a>
                        {% empty %}
                        <div class="text-center p-5">
                            <i class="fas fa-inbox fa-3x text-muted opacity-25 mb-3"></i>
                            <p class="text-muted">No messages yet.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="col-md-8 d-flex flex-column bg-light h-100 position-relative" id="chatArea">
                <!-- Empty State -->
                <div class="m-auto text-center p-5" id="chatPlaceholder">
                    <img src="{% static 'img/messaging_placeholder.svg' %}" alt="" style="max-width: 200px; margin-bottom: 2rem; opacity: 0.6;" onerror="this.style.display='none'">
                    <h4>Select a conversation</h4>
                    <p class="text-muted">Choose from the list to start chatting.</p>
                </div>

                <!-- Active Chat (Hidden by default) -->
                <div class="d-none flex-column h-100" id="activeChat">
                    <!-- Header -->
                    <div class="bg-white border-bottom p-3 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <h5 class="mb-0 fw-bold me-2" id="chatUserName">User</h5>
                            <span class="badge bg-secondary" id="chatContextBadge" style="display:none;">Context</span>
                        </div>
                        <button class="btn btn-sm btn-ghost d-md-none" id="backToList"><i class="fas fa-arrow-left"></i> Back</button>
                    </div>

                    <!-- Messages -->
                    <div class="flex-grow-1 overflow-auto p-4" id="messagesContainer">
                        <!-- Messages injected via JS -->
                    </div>

                    <!-- Input -->
                    <div class="p-3 bg-white border-top">
                        <form id="sendMessageForm">
                            <input type="hidden" name="recipient_id" id="inputRecipientId">
                            <input type="hidden" name="job_id" id="inputJobId">
                            <input type="hidden" name="course_id" id="inputCourseId">
                            <div class="input-group">
                                <input type="text" class="form-control" name="content" placeholder="Type a message..." required autocomplete="off">
                                <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="newConversationForm">
            <div class="mb-3 position-relative">
                <label class="form-label">To:</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="userSearchInput" placeholder="Search for people..." autocomplete="off">
                </div>
                <input type="hidden" name="recipient_id" id="selectedRecipientId" required>
                
                <!-- Search Results Dropdown -->
                <div class="list-group position-absolute w-100 shadow-sm mt-1 d-none" id="userSearchResults" style="z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                
                <!-- Selected User Display -->
                <div class="mt-2 d-none" id="selectedUserDisplay">
                    <div class="d-flex align-items-center p-2 border rounded bg-light">
                        <img src="" id="selectedUserImg" class="rounded-circle me-2" width="30" height="30">
                        <span class="fw-bold" id="selectedUserName">User</span>
                        <button type="button" class="btn-close ms-auto small" id="clearSelectedUser"></button>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Message</label>
                <textarea class="form-control" name="content" rows="3" required placeholder="Write your message..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100" id="sendMessageBtn" disabled>Send</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const activeChat = document.getElementById('activeChat');
    const chatPlaceholder = document.getElementById('chatPlaceholder');
    const messagesContainer = document.getElementById('messagesContainer');
    const chatUserName = document.getElementById('chatUserName');
    const chatContextBadge = document.getElementById('chatContextBadge');
    
    // Form Inputs
    const inputRecipientId = document.getElementById('inputRecipientId');
    const inputJobId = document.getElementById('inputJobId');
    const inputCourseId = document.getElementById('inputCourseId');

    // Conversation Click Handler
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            
            // UI Toggle
            chatPlaceholder.classList.add('d-none');
            activeChat.classList.remove('d-none');
            activeChat.classList.add('d-flex');
            
            // Set Header Info
            chatUserName.textContent = this.dataset.recipientName;
            const contextType = this.dataset.contextType;
            if (contextType !== 'direct') {
                chatContextBadge.textContent = this.dataset.contextTitle;
                chatContextBadge.className = 'badge ms-2 ' + (contextType === 'job' ? 'bg-primary' : 'bg-success');
                chatContextBadge.style.display = 'inline-block';
            } else {
                chatContextBadge.style.display = 'none';
            }

            // Set Form Inputs
            inputRecipientId.value = this.dataset.recipientId;
            inputJobId.value = this.dataset.jobId;
            inputCourseId.value = this.dataset.courseId;

            // Render Messages
            messagesContainer.innerHTML = '';
            const messages = JSON.parse(this.querySelector('.messages-data').textContent);
            
            messages.forEach(msg => {
                appendMessage(msg.content, msg.is_me, msg.timestamp);
            });
            scrollToBottom();
            
            // Highlight Active
            document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Send Message Handler
    document.getElementById('sendMessageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const contentInput = this.querySelector('input[name="content"]');
        const content = contentInput.value;
        const recipientId = inputRecipientId.value;
        const jobId = inputJobId.value;
        const courseId = inputCourseId.value;

        if(!content.trim()) return;

        const formData = new FormData();
        formData.append('recipient_id', recipientId);
        formData.append('content', content);
        if(jobId) formData.append('job_id', jobId);
        if(courseId) formData.append('course_id', courseId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("{% url 'jobs:send_message' %}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                appendMessage(data.message.content, true, data.message.timestamp);
                contentInput.value = '';
                scrollToBottom();
            }
        });
    });

    function appendMessage(content, isMe, timestamp) {
        const div = document.createElement('div');
        div.className = `d-flex mb-3 ${isMe ? 'justify-content-end' : 'justify-content-start'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `p-3 rounded-3 shadow-sm ${isMe ? 'bg-primary text-white' : 'bg-white border'}`;
        bubble.style.maxWidth = '75%';
        bubble.innerHTML = `
            <p class="mb-1">${content}</p>
            <small class="${isMe ? 'text-white-50' : 'text-muted'} text-xs d-block text-end">${timestamp}</small>
        `;
        
        div.appendChild(bubble);
        messagesContainer.appendChild(div);
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // --- User Search Logic ---
    const userSearchInput = document.getElementById('userSearchInput');
    const userSearchResults = document.getElementById('userSearchResults');
    const selectedRecipientId = document.getElementById('selectedRecipientId');
    const selectedUserDisplay = document.getElementById('selectedUserDisplay');
    const selectedUserImg = document.getElementById('selectedUserImg');
    const selectedUserName = document.getElementById('selectedUserName');
    const clearSelectedUser = document.getElementById('clearSelectedUser');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    let searchTimeout;

    userSearchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            userSearchResults.classList.add('d-none');
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`{% url 'jobs:search_users' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    userSearchResults.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(user => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action d-flex align-items-center px-3 py-2';
                            const imgUrl = user.profile_picture || `https://ui-avatars.com/api/?name=${user.username}&background=random`;
                            item.innerHTML = `
                                <img src="${imgUrl}" class="rounded-circle me-2" width="32" height="32">
                                <div>
                                    <div class="fw-bold text-sm">${user.name}</div>
                                    <div class="text-xs text-muted">@${user.username}</div>
                                </div>
                            `;
                            item.addEventListener('click', (e) => {
                                e.preventDefault();
                                selectUser(user);
                            });
                            userSearchResults.appendChild(item);
                        });
                        userSearchResults.classList.remove('d-none');
                    } else {
                         userSearchResults.innerHTML = '<div class="list-group-item text-muted text-center text-xs">No users found</div>';
                         userSearchResults.classList.remove('d-none');
                    }
                });
        }, 300);
    });

    function selectUser(user) {
        selectedRecipientId.value = user.id;
        selectedUserName.textContent = user.name;
        selectedUserImg.src = user.profile_picture || `https://ui-avatars.com/api/?name=${user.username}&background=random`;
        
        userSearchInput.value = '';
        userSearchResults.classList.add('d-none');
        userSearchInput.parentElement.classList.add('d-none');
        selectedUserDisplay.classList.remove('d-none');
        sendMessageBtn.disabled = false;
    }

    clearSelectedUser.addEventListener('click', () => {
        selectedRecipientId.value = '';
        selectedUserDisplay.classList.add('d-none');
        userSearchInput.parentElement.classList.remove('d-none');
        sendMessageBtn.disabled = true;
        userSearchInput.focus();
    });

    // Close search on outside click
    document.addEventListener('click', function(e) {
        if (!userSearchInput.contains(e.target) && !userSearchResults.contains(e.target)) {
            userSearchResults.classList.add('d-none');
        }
    });

    // Handle New Message Form Submit
    document.getElementById('newConversationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const contentInput = this.querySelector('textarea[name="content"]');
        const content = contentInput.value;
        const recipientId = selectedRecipientId.value;

        if(!content.trim() || !recipientId) return;

        const formData = new FormData();
        formData.append('recipient_id', recipientId);
        formData.append('content', content);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("{% url 'jobs:send_message' %}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                // Ideally redirect to the conversation or reload
                window.location.reload(); 
            }
        });
    });
});
</script>
{% endblock %}
