{% extends 'base.html' %}
{% load static %}

{% block title %}{{ lesson.title }} | {{ course.title }}{% endblock %}

{% block content %}
<!-- Plyr CSS -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<style>
    :root {
        --plyr-color-main: #3b82f6;
    }
    /* Custom Scrollbar for Light Theme */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f8fafc; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .player-container {
        height: 70vh;
        background: #f1f5f9;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .lesson-item {
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        color: #475569;
    }
    .lesson-item:hover {
        background-color: #f8fafc;
        color: #1e293b;
    }
    .lesson-item.active {
        background-color: #eff6ff;
        border-left-color: #3b82f6;
        color: #2563eb;
        font-weight: 600;
    }
    
    .btn-control {
        transition: all 0.2s;
    }
    .btn-control:hover {
        transform: translateY(-1px);
    }
    
    /* Plyr Customizations */
    .plyr {
        height: 100%;
        width: 100%;
    }
    .plyr--video {
        max-height: 100%;
    }
    .player-section-wrapper {
        background: #000;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>

<!-- Player Section -->
<div class="bg-white">
    <!-- Header -->
    <div class="bg-white text-dark pb-3 border-bottom">
        <div class="container-fluid px-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{% url 'jobs:course_detail' course.slug %}" class="btn btn-icon btn-sm btn-outline-secondary me-3 rounded-circle" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <div class="text-xs text-uppercase tracking-wider text-muted fw-bolder mb-0" style="font-size: 0.75rem; letter-spacing: 0.05em;">{{ course.title }}</div>
                    <h5 class="mb-0 fw-bold text-dark">{{ lesson.title }}</h5>
                </div>
            </div>
            <div>
                 <span class="badge bg-light text-muted border rounded-pill px-3 py-2 fw-normal">
                    <i class="far fa-clock me-1"></i> {{ lesson.duration }}
                 </span>
            </div>
        </div>
    </div>

    <!-- Player Container -->
    <div class="player-container border-bottom">
        <div class="row g-0 h-100">
            <!-- Main Stage (Video) -->
            <div class="col-lg-9 bg-light h-100 d-flex flex-column position-relative">
                <!-- Video Area -->
                <div class="flex-grow-1 player-section-wrapper overflow-hidden relative">
                    {% if is_enrolled %}
                            {% if lesson.video_url %}
                                {% if "youtube.com" in lesson.video_url or "youtu.be" in lesson.video_url %}
                                    <div class="plyr__video-embed" id="player">
                                        <iframe src="{{ lesson.video_url }}?origin=http://localhost:8000&amp;iv_load_policy=3&amp;modestbranding=1&amp;playsinline=1&amp;showinfo=0&amp;rel=0&amp;enablejsapi=1" 
                                                allowfullscreen allowtransparency allow="autoplay"></iframe>
                                    </div>
                                {% elif "vimeo.com" in lesson.video_url %}
                                    <div class="plyr__video-embed" id="player">
                                        <iframe src="{{ lesson.video_url }}?loop=false&amp;byline=false&amp;portrait=false&amp;title=false&amp;speed=true&amp;transparent=0&amp;gesture=media" 
                                                allowfullscreen allowtransparency allow="autoplay"></iframe>
                                    </div>
                                {% elif ".mp4" in lesson.video_url or ".webm" in lesson.video_url %}
                                    <video id="player" playsinline controls controlsList="nodownload">
                                        <source src="{{ lesson.video_url }}" type="video/mp4">
                                    </video>
                                {% else %}
                                    <iframe src="{{ lesson.video_url }}" title="{{ lesson.title }}" allowfullscreen id="player"></iframe>
                                {% endif %}
                            {% elif lesson.video_file %}
                                <video id="player" playsinline controls controlsList="nodownload">
                                    <source src="{{ lesson.video_file.url }}" type="video/mp4">
                                </video>
                            {% else %}
                            <div class="d-flex align-items-center justify-content-center h-100 text-white bg-dark w-100">
                                <div class="text-center p-5">
                                    <i class="fas fa-video-slash fa-3x mb-3 text-secondary opacity-50"></i>
                                    <h4 class="text-secondary">Video source unavailable</h4>
                                </div>
                            </div>
                            {% endif %}
                    {% else %}
                    <div class="d-flex align-items-center justify-content-center w-100 h-100 text-white bg-dark">
                        <div class="text-center p-5 animate-fade-in" style="max-width: 500px;">
                            <div class="mb-4">
                                <span class="d-inline-flex align-items-center justify-content-center rounded-circle bg-warning bg-opacity-10 p-4">
                                    <i class="fas fa-lock fa-3x text-warning"></i>
                                </span>
                            </div>
                            <h2 class="fw-bold mb-2">Content Locked</h2>
                            <p class="text-white-50 mb-4">Enroll in this course to access the full curriculum.</p>
                            <a href="{% url 'jobs:course_detail' course.slug %}" class="btn btn-primary btn-lg px-5 fw-bold rounded-pill shadow-lg hover-scale">Enroll Now</a>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Controls Bar -->
                <div class="bg-white border-top py-3 px-4 d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-3 align-items-center">
                        <!-- Custom Skip Controls -->
                        <div class="d-flex bg-light rounded-pill p-1">
                            <button id="rewind-btn" class="btn btn-sm btn-icon border-0 text-muted hover-primary" title="Backward 10s">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button id="fast-forward-btn" class="btn btn-sm btn-icon border-0 text-muted hover-primary" title="Forward 10s">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        
                        <div class="vr mx-1 text-muted opacity-25" style="height: 20px;"></div>
                        
                        <div class="d-flex gap-2">
                            <a href="#lesson-resources" class="btn btn-sm btn-control btn-light text-muted border-0 rounded-pill px-3 d-none d-md-inline-block"><i class="fas fa-info-circle me-2"></i>Overview</a>
                            <button class="btn btn-sm btn-control btn-light text-muted border-0 rounded-pill px-3"><i class="fas fa-comment-alt me-2"></i>Q&A</button>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 align-items-center">

                        {% if prev_lesson %}
                        <a href="{% url 'jobs:lesson_detail' prev_lesson.slug %}" class="btn btn-sm btn-control btn-outline-dark px-3 rounded-pill" title="Previous Lesson">
                            <i class="fas fa-chevron-left"></i> <span class="d-none d-md-inline ms-1">Prev</span>
                        </a>
                        {% else %}
                        <button class="btn btn-sm btn-outline-secondary px-3 rounded-pill opacity-50" disabled><i class="fas fa-chevron-left"></i></button>
                        {% endif %}
                        
                        {% if next_lesson %}
                        <a href="{% url 'jobs:lesson_detail' next_lesson.slug %}" class="btn btn-sm btn-control btn-primary px-3 rounded-pill" title="Next Lesson">
                            <span class="d-none d-md-inline me-1">Next</span> <i class="fas fa-chevron-right"></i>
                        </a>
                        {% else %}
                        <a href="{% url 'jobs:mark_lesson_complete' lesson.slug %}" class="btn btn-sm btn-success px-4 rounded-pill fw-bold shadow-sm">
                            <i class="fas fa-check-circle me-2"></i>Complete Course
                        </a>
                        {% endif %}
                        
                        {% if not is_completed %}
                        <a href="{% url 'jobs:mark_lesson_complete' lesson.slug %}" class="btn btn-sm btn-outline-success px-3 rounded-pill ms-2" title="Mark as Finished">
                            <i class="fas fa-check"></i> <span class="d-none d-md-inline ms-1">Mark Finished</span>
                        </a>
                        {% else %}
                        <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3 py-2 ms-2 border border-success border-opacity-25 shadow-sm anima-pulse">
                            <i class="fas fa-check-double me-1"></i> Completed
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar (Curriculum) -->
            <div class="col-lg-3 bg-white border-start h-100 d-flex flex-column">
                <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark small text-uppercase tracking-wide">Course Content</h6>
                </div>
                <div class="overflow-auto custom-scroll flex-grow-1">
                    <div class="accordion accordion-flush bg-transparent" id="curriculumAccordion">
                        {% for module in all_modules %}
                        <div class="accordion-item bg-transparent border-0">
                            <h2 class="accordion-header" id="heading{{ module.id }}">
                                <button class="accordion-button {% if lesson.module.id != module.id %}collapsed{% endif %} py-3 fw-bold bg-transparent text-dark shadow-none border-bottom text-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ module.id }}">
                                    {{ module.title }}
                                </button>
                            </h2>
                            <div id="collapse{{ module.id }}" class="accordion-collapse collapse {% if lesson.module.id == module.id %}show{% endif %}" data-bs-parent="#curriculumAccordion">
                                <div class="accordion-body p-0">
                                    <div class="list-group list-group-flush rounded-0">
                                        {% for l in module.lessons.all %}
                                        <a href="{% url 'jobs:lesson_detail' l.slug %}" class="list-group-item list-group-item-action py-3 px-4 border-bottom lesson-item {% if l.id == lesson.id %}active{% endif %}">
                                            <div class="d-flex align-items-start gap-3">
                                                <div class="mt-1">
                                                     {% if l.id == lesson.id %}
                                                        <i class="fas fa-play-circle text-primary"></i>
                                                     {% else %}
                                                        <i class="far fa-play-circle opacity-50"></i>
                                                     {% endif %}
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="small fw-medium lh-sm">{{ l.title }}</div>
                                                    <div class="text-xs mt-1 opacity-50"><i class="far fa-clock me-1"></i> {{ l.duration }}</div>
                                                </div>
                                            </div>
                                        </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container py-5" id="lesson-resources">
    <div class="row">
        <div class="col-lg-8">
            <h3 class="fw-bold mb-4 text-dark">About this lesson</h3>
            <div class="prose max-w-none text-muted mb-5 lh-lg">
                {{ lesson.description|linebreaks }}
            </div>

            {% if lesson.pdf_notes %}
            <div class="card border-0 bg-light p-4 rounded-4 d-flex flex-row align-items-center shadow-sm">
                <div class="bg-white text-danger p-3 rounded-circle me-4 shadow-sm" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-file-pdf fa-2x"></i>
                </div>
                <div>
                    <h5 class="fw-bold mb-1 text-dark">Download Notes</h5>
                    <p class="text-muted small mb-0">Get the PDF companion for this lesson.</p>
                </div>
                <a href="{{ lesson.pdf_notes.url }}" class="btn btn-dark ms-auto fw-bold rounded-pill px-4" download>Download</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Plyr JS -->
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const playerElement = document.getElementById('player');
        if (!playerElement) return;

        const player = new Plyr('#player', {
            controls: [
                'play-large',
                'play',
                'progress',
                'current-time',
                'mute',
                'volume',
                'captions',
                'settings',
                'pip',
                'airplay',
                'fullscreen',
            ],
            settings: ['captions', 'quality', 'speed', 'loop'],
            speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 4] },
            // Remove download option for direct video links
            download: false,
            // Keep it full screen capable
            fullscreen: { enabled: true, fallback: true, iosNative: true },
            // Quality options
            quality: { default: 720, options: [4320, 2880, 2160, 1440, 1080, 720, 576, 480, 360, 240] }
        });

        // Global access for custom controls
        window.player = player;

        // Custom Skip Logic
        const rewindBtn = document.getElementById('rewind-btn');
        const ffBtn = document.getElementById('fast-forward-btn');

        if (rewindBtn) {
            rewindBtn.addEventListener('click', () => {
                player.rewind(10);
            });
        }

        if (ffBtn) {
            ffBtn.addEventListener('click', () => {
                player.forward(10);
            });
        }

        // Spacebar to play/pause
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target === document.body) {
                e.preventDefault();
                player.togglePlay();
            }
        });
    });
</script>
{% endblock %}
